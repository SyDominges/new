<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاستعلام عن البيانات الشخصية</title>
    <style>
        :root {
            --primary-color: #3498db;
            --error-color: #e74c3c;
            --success-color: #2ecc71;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* تصميم صفحة تسجيل الدخول */
        .login-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
        
        .login-container h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-logout {
            background-color: var(--error-color);
        }
        
        .btn-logout:hover {
            background-color: #c0392b;
        }
        
        .alert {
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: var(--error-color);
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .loading {
            text-align: center;
            padding: 15px;
            display: none;
        }
        
        .employee-details {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-top: 30px;
            display: none;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: bold;
            width: 150px;
            color: #555;
        }
        
        .detail-value {
            flex: 1;
        }
        
        /* الصفحة الرئيسية */
        .main-container {
            display: none;
            max-width: 600px;
            margin: 30px auto;
        }
        
        .search-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .instructions {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .login-container, .main-container {
                padding: 20px;
                margin: 20px auto;
            }
            
            .detail-row {
                flex-direction: column;
            }
            
            .detail-label {
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- صفحة تسجيل الدخول -->
    <div class="container">
        <div class="login-container" id="loginContainer">
            <h1>تسجيل الدخول</h1>
            <div class="alert alert-error" id="loginError">اسم المستخدم أو كلمة المرور غير صحيحة</div>
            
            <div class="form-group">
                <label for="username">اسم المستخدم</label>
                <input type="text" id="username" class="form-control" placeholder="أدخل اسم المستخدم">
            </div>
            
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" class="form-control" placeholder="أدخل كلمة المرور">
            </div>
            
            <button class="btn" id="loginButton">دخول</button>
        </div>
        
        <!-- الصفحة الرئيسية -->
        <div class="main-container" id="mainContainer">
            <div class="search-container">
                <h1>الاستعلام عن البيانات الشخصية</h1>
                <p class="instructions">الرجاء إدخال الرقم الوطني للاستعلام عن البيانات</p>
                
                <div class="alert alert-error" id="errorMessage">الرقم الوطني يجب أن يحتوي على 11 رقمًا على الأقل</div>
                
                <div class="form-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="أدخل الرقم الوطني (11 رقمًا)" maxlength="11" inputmode="numeric">
                </div>
                
                <button class="btn" id="searchButton">استعلام</button>
            </div>
            
            <div class="loading" id="loading">
                <p>جاري البحث عن البيانات...</p>
            </div>
            
            <div class="alert alert-error" id="noResults">لا توجد بيانات مطابقة للرقم الوطني المدخل</div>
            
            <div class="employee-details" id="employeeDetails">
                <h2 id="employeeName">بيانات الموظف</h2>
                <div id="detailsContent"></div>
            </div>
            
            <button class="btn btn-logout" id="logoutButton">تسجيل الخروج</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // بيانات تسجيل الدخول (SHA-256)
        const CORRECT_USERNAME_HASH = "94419b99b12c11133a4dfeccc3e17885974beb48f7827c48239aabfbcad238d8";
        const CORRECT_PASSWORD_HASH = "94419b99b12c11133a4dfeccc3e17885974beb48f7827c48239aabfbcad238d8";
        const ENCRYPTION_KEY = "@ali96json@";
        let failedAttempts = 0;
        const MAX_ATTEMPTS = 3;
        
        // عناصر DOM
        const loginContainer = document.getElementById('loginContainer');
        const mainContainer = document.getElementById('mainContainer');
        const loginError = document.getElementById('loginError');
        const errorMessage = document.getElementById('errorMessage');
        const noResults = document.getElementById('noResults');
        const loading = document.getElementById('loading');
        const employeeDetails = document.getElementById('employeeDetails');
        const logoutButton = document.getElementById('logoutButton');
        
        // بيانات التطبيق
        let allEmployees = [];
        
        // أحداث تسجيل الدخول
        document.getElementById('loginButton').addEventListener('click', function() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (failedAttempts >= MAX_ATTEMPTS) {
                loginError.textContent = 'تم تجاوز عدد المحاولات المسموح بها';
                loginError.style.display = 'block';
                return;
            }
            
            const hashedUsername = CryptoJS.SHA256(username).toString();
            const hashedPassword = CryptoJS.SHA256(password).toString();
            
            if (hashedUsername === CORRECT_USERNAME_HASH && hashedPassword === CORRECT_PASSWORD_HASH) {
                loginError.style.display = 'none';
                loginContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                loadEmployeeData();
            } else {
                failedAttempts++;
                loginError.style.display = 'block';
                loginError.textContent = `بيانات الدخول غير صحيحة. المحاولات المتبقية: ${MAX_ATTEMPTS - failedAttempts}`;
            }
        });
        
        // تحميل بيانات الموظفين
        // جرب هذه الدالة البديلة للفك
function alternativeDecrypt(data) {
    try {
        // الطريقة الأساسية
        const bytes = CryptoJS.AES.decrypt(
            data,
            CryptoJS.enc.Utf8.parse(ENCRYPTION_KEY)
        );
        let decrypted = bytes.toString(CryptoJS.enc.Utf8);
        
        // إذا فشلت، جرب بدون خيارات
        if (!decrypted) {
            decrypted = CryptoJS.AES.decrypt(
                data,
                ENCRYPTION_KEY
            ).toString(CryptoJS.enc.Utf8);
        }
        
        return JSON.parse(decrypted);
    } catch (e) {
        console.error("فشل الفك بالطريقتين:", e);
        throw e;
    }
}
        function loadEmployeeData() {
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            
        const BASE_URL = "https://cdn.jsdelivr.net/gh/SyDominges/new@e76f37fc34300a0821ca00613a8b801b05494fba/";
            Promise.all([
                fetch(`${baseUrl}encrypted_part11.json`).then(res => res.text()),
                fetch(`${baseUrl}encrypted_part22.json`).then(res => res.text())
            ])
            .then(([part1, part2]) => {
                try {
                    const decrypt = (data) => {
                        const bytes = CryptoJS.AES.decrypt(
                            data.trim(),
                            CryptoJS.enc.Utf8.parse(ENCRYPTION_KEY),
                            {
                                mode: CryptoJS.mode.CBC,
                                padding: CryptoJS.pad.Pkcs7
                            }
                        );
                        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                        if (!decrypted) throw new Error('فشل فك التشفير');
                        return JSON.parse(decrypted);
                    };

                    const data1 = decrypt(part1);
                    const data2 = decrypt(part2);
                    
                    allEmployees = [...Object.values(data1), ...Object.values(data2)];
                    
                    if (allEmployees.length === 0) throw new Error('لا توجد بيانات');
                    
                    loading.style.display = 'none';
                } catch (error) {
                    console.error('Error:', error);
                    errorMessage.textContent = 'حدث خطأ في تحميل البيانات';
                    errorMessage.style.display = 'block';
                    loading.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                errorMessage.textContent = 'فشل في تحميل الملفات';
                errorMessage.style.display = 'block';
                loading.style.display = 'none';
            });
        }
        
        // البحث عن الموظف
        document.getElementById('searchButton').addEventListener('click', performSearch);
        function debugData() {
    console.log("====== بدء التحليل التشخيصي ======");
    
    // 1. التحقق من جودة البيانات المحملة
    console.log("عدد السجلات المحملة:", allEmployees.length);
    if (allEmployees.length > 0) {
        console.log("عينة من أول سجل:", JSON.stringify(allEmployees[0], null, 2));
        
        // 2. التحقق من وجود حقل الرقم الوطني
        const firstEmp = allEmployees[0];
        if (!firstEmp['الرقم الوطني']) {
            console.error("تحذير: لا يوجد حقل 'الرقم الوطني' في السجلات");
        } else {
            console.log("نموذج الرقم الوطني في البيانات:", firstEmp['الرقم الوطني']);
        }
    }
    
    // 3. اختبار البحث يدويًا
    const testNationalId = "123456789"; // استبدلها برقم تجريبي موجود ببياناتك
    const found = allEmployees.some(emp => {
        const empId = emp['الرقم الوطني']?.replace(/\D/g, '') || '';
        return empId.includes(testNationalId);
    });
    console.log(`اختبار البحث عن ${testNationalId}:`, found ? "موجود" : "غير موجود");
    
    console.log("====== انتهاء التحليل ======");
}

// استدعاء الدالة بعد تحميل البيانات
// أضف هذا السطر في نهاية دالة loadEmployeeData بعد نجاح التحميل:
debugData();
      function performSearch() {
    const searchInput = document.getElementById('searchInput');
    let searchTerm = searchInput.value.trim().replace(/\D/g, '');
    
    if (searchTerm.startsWith('0')) {
        searchTerm = searchTerm.substring(1);
    }
    
    if (searchTerm.length < 8) {
        errorMessage.textContent = 'الرجاء إدخال 8 أرقام على الأقل';
        errorMessage.style.display = 'block';
        return;
    }
    
    // تفعيل وضع التصحيح
    console.log(`====== بدء البحث عن: ${searchTerm} ======`);
    
    errorMessage.style.display = 'none';
    noResults.style.display = 'none';
    employeeDetails.style.display = 'none';
    loading.style.display = 'block';
    
    setTimeout(() => {
        loading.style.display = 'none';
        
        try {
            let foundEmployee = null;
            
            // تسجيل جميع الأرقام الوطنية المتاحة للتصحيح
            console.log("الأرقام الوطنية المتاحة:");
            allEmployees.forEach((emp, index) => {
                const empId = emp['الرقم الوطني']?.replace(/\D/g, '') || '';
                console.log(`السجل ${index + 1}: ${empId}`);
                
                if (empId.includes(searchTerm)) {
                    foundEmployee = emp;
                }
            });
            
            if (foundEmployee) {
                console.log("تم العثور على:", foundEmployee);
                displayEmployeeDetails(foundEmployee);
            } else {
                console.warn("لم يتم العثور على نتائج مطابقة");
                noResults.style.display = 'block';
                
                // اقتراحات لاستكشاف الأخطاء
                if (allEmployees.length === 0) {
                    console.error("البيانات فارغة! تأكد من:");
                    console.error("- صحة كلمة سر التشفير");
                    console.error("- تنسيق الملفات المشفرة");
                } else {
                    console.warn("نصائح استكشاف الأخطاء:");
                    console.warn("- تأكد من تطابق تنسيق الرقم المدخل مع البيانات");
                    console.warn("- جرب البحث بأجزاء من الرقم (8 أرقام بدلاً من 11)");
                }
            }
        } catch (error) {
            console.error("حدث خطأ أثناء البحث:", error);
            errorMessage.textContent = 'حدث خطأ أثناء معالجة البحث';
            errorMessage.style.display = 'block';
        }
    }, 800);
        }
        
        // عرض تفاصيل الموظف
        function displayEmployeeDetails(employee) {
            document.getElementById('employeeName').textContent = employee['الاسم والنسبة'] || 'بيانات الموظف';
            const detailsContent = document.getElementById('detailsContent');
            detailsContent.innerHTML = '';
            
            const fields = [
                'الرقم الذاتي', 'الاسم', 'النسبة', 'اسم الأب', 'اسم الأم',
                'المواليد / اليوم', 'المواليد / شهر', 'المواليد / عام',
                'الولادة والتاريخ', 'الرقم الوطني', 'الشهادة', 'التخصص',
                'مسمى وظيفي', 'الجهة'
            ];
            
            fields.forEach(field => {
                if (employee[field] && employee[field] !== 'null') {
                    const row = document.createElement('div');
                    row.className = 'detail-row';
                    
                    const label = document.createElement('div');
                    label.className = 'detail-label';
                    label.textContent = `${field}:`;
                    
                    const value = document.createElement('div');
                    value.className = 'detail-value';
                    value.textContent = employee[field];
                    
                    row.appendChild(label);
                    row.appendChild(value);
                    detailsContent.appendChild(row);
                }
            });
            
            employeeDetails.style.display = 'block';
        }
        
        // تسجيل الخروج
        logoutButton.addEventListener('click', function() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                location.reload();
            }
        });
        
        // إدخال الرقم الوطني
        document.getElementById('searchInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.replace(/^0/, '').length >= 8) {
                errorMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>
